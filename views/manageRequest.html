<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Resource Management</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="/css/firstPage.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
      body {
        position: relative;
        overflow-x: hidden;
        background: #f0f2f5; /* Light gray background */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }

      .main-content {
        padding: 30px 40px;
        margin-left: 240px;
        transition: margin 0.3s ease;
      }

      .section-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid rgba(0, 0, 128, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        animation: fadeIn 0.5s ease-in-out;
        transition: all 0.3s ease;
      }

      .section-card:hover {
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
      }

      .section-card h2 {
        font-size: 1.8rem;
        color: #2a4365;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-card h2 i {
        color: #4361ee;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-header h2 {
        margin-bottom: 0;
        border-bottom: none;
        padding-bottom: 0;
      }

      .resources-grid,
      .donations-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .requests-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 20px;
        overflow-x: auto;
        display: block;
      }

      .resource-card,
      .donation-card {
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }

      .resource-card:hover,
      .donation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .resource-category {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
        position: absolute;
        top: 15px;
        right: 15px;
      }

      .category-food {
        background-color: #e7f5ff;
        color: #1890ff;
      }

      .category-medicine {
        background-color: #f0f9eb;
        color: #52c41a;
      }

      .category-essentials {
        background-color: #fff7e6;
        color: #fa8c16;
      }

      .resource-card i,
      .donation-card i {
        font-size: 2.5rem;
        color: #4361ee;
        margin-bottom: 15px;
        display: block;
      }

      .resource-card h3,
      .donation-card h3 {
        color: #2d3748;
        font-size: 1.2rem;
        margin-bottom: 10px;
      }

      .resource-card p,
      .donation-card p {
        color: #4a5568;
        margin: 8px 0;
        font-size: 0.95rem;
      }

      .resource-details {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
      }

      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-top: 10px;
      }

      .status.in-stock,
      .status.available {
        background: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
      }

      .status.low-stock {
        background: rgba(255, 152, 0, 0.15);
        color: #ff9800;
      }

      .status.out-of-stock,
      .status.claimed {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
      }

      .action-btn {
        background: #4361ee;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .action-btn:hover {
        background: #3a56d4;
        transform: translateY(-2px);
      }

      .action-btn:active {
        transform: translateY(0);
      }

      .action-btn i {
        font-size: 1rem;
        margin: 0;
      }

      .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .requests-table {
        min-width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
      }

      .table-header,
      .table-row {
        display: table;
        table-layout: fixed;
        width: 100%;
      }

      .table-header {
        background: #f8fafc;
        font-weight: 600;
      }

      .table-header div {
        padding: 15px;
        color: #4a5568;
        text-align: left;
        font-size: 0.95rem;
      }

      .table-row {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s ease;
      }

      .table-row:hover {
        background: #f8fafc;
      }

      .table-row:last-child {
        border-bottom: none;
      }

      .table-header div,
      .table-row div {
        display: table-cell;
        padding: 12px 15px;
        vertical-align: middle;
      }

      .filter {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .filter-group i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
      }

      .filter input,
      .filter select {
        width: 100%;
        padding: 10px 15px 10px 35px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: white;
        color: #4a5568;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .filter input:focus,
      .filter select:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        background: white;
        width: 90%;
        max-width: 600px;
        margin: 50px auto;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease;
        max-height: 85vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
      }

      .modal-header h3 {
        color: #2d3748;
        font-size: 1.5rem;
        margin: 0;
      }

      .modal-content .close {
        font-size: 1.5rem;
        cursor: pointer;
        color: #a0aec0;
        transition: color 0.2s ease;
      }

      .modal-content .close:hover {
        color: #4a5568;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #4a5568;
        font-weight: 500;
      }

      .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .modal-content input,
      .modal-content select,
      .modal-content textarea {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: white;
        color: #4a5568;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .modal-content input:focus,
      .modal-content select:focus,
      .modal-content textarea:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .modal-content textarea {
        resize: vertical;
        min-height: 100px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        border: none;
      }

      .btn-primary {
        background: #4361ee;
        color: white;
      }

      .btn-primary:hover {
        background: #3a56d4;
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .btn-secondary:hover {
        background: #cbd5e0;
      }

      .action-btn.accept-btn {
        background: #10b981;
      }

      .action-btn.accept-btn:hover {
        background: #059669;
      }

      .action-btn.reject-btn {
        background: #ef4444;
      }

      .action-btn.reject-btn:hover {
        background: #dc2626;
      }

      .action-btn.view-btn {
        background: #3b82f6;
      }

      .action-btn.view-btn:hover {
        background: #2563eb;
      }

      .action-btn:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
      }

      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-pending {
        background: #fff7e6;
        color: #fa8c16;
      }

      .badge-approved {
        background: #f0f9eb;
        color: #52c41a;
      }

      .badge-rejected {
        background: #fff1f0;
        color: #f5222d;
      }

      .badge-delivered {
        background: #e6f7ff;
        color: #1890ff;
      }

      .request-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .request-details-grid p {
        margin: 0;
        padding: 10px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .request-details-grid p strong {
        display: block;
        margin-bottom: 5px;
        color: #4a5568;
        font-size: 0.85rem;
      }

      .request-details-grid p span {
        color: #2d3748;
        font-size: 1rem;
      }

      .request-items {
        margin: 20px 0;
      }

      .request-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .request-item-details {
        flex: 1;
      }

      .request-item-name {
        font-weight: 500;
        color: #2d3748;
      }

      .request-item-meta {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 3px;
      }

      .request-item-price {
        font-weight: 500;
        color: #2d3748;
      }

      .error-message {
        color: #ef4444;
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background: #fff1f0;
        border-radius: 8px;
        font-weight: 500;
      }

      .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
      }

      .stat-icon i {
        font-size: 1.5rem;
        color: white;
      }

      .stat-icon.requests {
        background: linear-gradient(45deg, #4361ee, #3f37c9);
      }

      .stat-icon.pending {
        background: linear-gradient(45deg, #fa8c16, #ffc53d);
      }

      .stat-icon.approved {
        background: linear-gradient(45deg, #52c41a, #85e649);
      }

      .stat-icon.resources {
        background: linear-gradient(45deg, #1890ff, #69c0ff);
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #718096;
        font-size: 0.9rem;
      }

      .no-items {
        padding: 30px;
        text-align: center;
        color: #718096;
      }

      .no-items i {
        font-size: 3rem;
        color: #e2e8f0;
        margin-bottom: 15px;
      }

      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: white;
        color: #2d3748;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 9999;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      }

      .toast.success .toast-icon {
        background: #f0f9eb;
        color: #52c41a;
      }

      .toast.error .toast-icon {
        background: #fff1f0;
        color: #f5222d;
      }

      .toast-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .toast-content {
        flex: 1;
      }

      .toast-title {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .toast-message {
        font-size: 0.9rem;
        color: #718096;
      }

      .loadingSpinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4361ee;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          visibility: hidden;
        }
      }

      @media (max-width: 1024px) {
        .main-content {
          margin-left: 0;
          padding: 20px;
        }

        .resources-grid,
        .donations-list {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 15px;
        }

        .dashboard-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .section-card {
          padding: 15px;
        }

        .request-details-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          flex-direction: column;
          gap: 10px;
        }

        .filter {
          flex-direction: column;
          gap: 10px;
        }

        .filter-group {
          min-width: 100%;
        }
      }

      @media (max-width: 480px) {
        .dashboard-stats {
          grid-template-columns: 1fr;
        }

        .stat-card {
          padding: 15px 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Particle Background -->
    <div id="particles-js"></div>

    <!-- Sidebar (unchanged) -->
    <div class="logo" onclick="window.location.href='/'">
      <img
        src="/images/logo.png"
        alt="Pandemic Response Logo"
        class="logo-img"
      />
    </div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-links">
        <a href="/" class="sidebar-link"
          ><i class="fa-solid fa-home"></i> Home</a
        >
        <a href="/firstPage" class="sidebar-link"
          ><i class="fa-solid fa-virus"></i> Dashboard</a
        >
        <a href="/pandamic" class="sidebar-link"
          ><i class="fa-solid fa-virus"></i> Pandemic Hub</a
        >
        <a href="/request" class="sidebar-link"
          ><i class="fa-solid fa-box-open"></i> Need Resources</a
        >
        <a href="/map" class="sidebar-link"
          ><i class="fa-solid fa-hospital"></i> Find Hospitals</a
        >
        <a href="/stats" class="sidebar-link"
          ><i class="fa-solid fa-chart-pie"></i> Graph Analytics</a
        >
        <a href="/organizations" class="sidebar-link"
          ><i class="fa-solid fa-building"></i> Organizations</a
        >
        <a href="/org-dashboard" class="sidebar-link"
          ><i class="fa-solid fa-tachometer-alt"></i> Org Dashboard</a
        >
        <a href="/user-dashboard" class="sidebar-link"
          ><i class="fa-solid fa-user"></i> User Dashboard</a
        >
        <a href="/alerts" class="sidebar-link"
        ><i class="fa-solid fa-alert"></i> Alerts</a
      >
        <a href="/profile" class="sidebar-link"
          ><i class="fa-solid fa-id-card"></i> Profile</a
        >
        <a href="/admin" class="sidebar-link active"
          ><i class="fa-solid fa-cogs"></i> Admin Dashboard</a
        >
        <a href="/hospital-dashboard" class="sidebar-link active"
          ><i class="fa-solid fa-heartbeat"></i> Hospital Dashboard</a
        >
      </div>
      <div class="user-profile">
        <img
          src="/default-user.png"
          alt="User Photo"
          id="user-photo"
          class="user-photo"
          onclick="toggleSidebarMobile()"
        />
        <div class="user-info">
          <span id="user-name">Admin</span>
        </div>
        <button class="profile-btn" onclick="window.location.href='/profile'">
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>
    </div>
    <div class="mobile-toggle" onclick="toggleSidebarMobile()">
      <i class="fa-solid fa-bars mobile-hamburger"></i>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <div id="error-message" class="error-message"></div>

      <!-- Dashboard Stats -->
      <div class="dashboard-stats" id="dashboard-stats">
        <div class="stat-card">
          <div class="stat-icon requests">
            <i class="fa-solid fa-list-check"></i>
          </div>
          <div class="stat-value" id="stats-total-requests">0</div>
          <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon pending">
            <i class="fa-solid fa-clock"></i>
          </div>
          <div class="stat-value" id="stats-pending-requests">0</div>
          <div class="stat-label">Pending Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon approved">
            <i class="fa-solid fa-check-circle"></i>
          </div>
          <div class="stat-value" id="stats-approved-requests">0</div>
          <div class="stat-label">Approved Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon resources">
            <i class="fa-solid fa-boxes-stacked"></i>
          </div>
          <div class="stat-value" id="stats-total-resources">0</div>
          <div class="stat-label">Resource Types</div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><i class="fa-solid fa-boxes"></i> Manage Resources</h2>
          <button class="action-btn" onclick="openAddResourceModal()">
            <i class="fa-solid fa-plus"></i> Add Resource
          </button>
        </div>
        <div class="resources-grid" id="resources-grid">
          <div class="loadingSpinner"></div>
        </div>
      </div>

      <div class="section-card">
        <h2><i class="fa-solid fa-list"></i> Manage Requests</h2>
        <div class="filter">
          <div class="filter-group">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input
              type="text"
              id="search"
              placeholder="Search by name or email..."
              onkeyup="filterRequests()"
            />
          </div>
          <div class="filter-group">
            <i class="fa-solid fa-filter"></i>
            <select id="status-filter" onchange="filterRequests()">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <button class="action-btn" onclick="openAddRequestModal()">
            <i class="fa-solid fa-plus"></i> Add Request
          </button>
        </div>
        <div class="table-container">
          <div class="requests-table" id="requests-table">
            <div class="table-header">
              <div>Request ID</div>
              <div>Name</div>
              <div>Email</div>
              <div>Type</div>
              <div>Total</div>
              <div>Status</div>
              <div>Actions</div>
            </div>
            <div id="requests-loading" class="loadingSpinner"></div>
            <div id="no-requests" class="no-items" style="display: none">
              <i class="fa-solid fa-inbox"></i>
              <p>No requests found</p>
            </div>
          </div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2>
            <i class="fa-solid fa-hand-holding-heart"></i> Manage Donations
          </h2>
          <button class="action-btn" onclick="refreshDonations()">
            <i class="fa-solid fa-refresh"></i> Refresh
          </button>
        </div>
        <div class="donations-list" id="donations-list">
          <div class="loadingSpinner"></div>
        </div>
      </div>
    </main>

    <!-- Resource Update Modal -->
    <div class="modal" id="resource-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Update Resource</h3>
          <span class="close" onclick="closeModal('resource-modal')">×</span>
        </div>
        <form id="update-resource-form">
          <input type="hidden" id="resource-id" />
          <div class="form-group">
            <label for="resource-name">Resource Name</label>
            <input type="text" id="resource-name" readonly />
          </div>
          <div class="form-group">
            <label for="resource-category">Category</label>
            <input type="text" id="resource-category" readonly />
          </div>
          <div class="form-group">
            <label for="resource-price">Price (₹)</label>
            <input type="number" id="resource-price" step="1" min="0" />
          </div>
          <div class="form-group">
            <label for="resource-stock">Current Stock</label>
            <input type="number" id="resource-stock" min="0" />
          </div>
          <div class="form-group">
            <label for="resource-description">Description</label>
            <textarea id="resource-description" rows="3"></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('resource-modal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Update Resource
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Resource Modal -->
    <div class="modal" id="add-resource-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Resource</h3>
          <span class="close" onclick="closeModal('add-resource-modal')"
            >×</span
          >
        </div>
        <form id="add-resource-form">
          <div class="form-group">
            <label for="new-resource-id">Resource ID</label>
            <input
              type="text"
              id="new-resource-id"
              placeholder="Unique ID for the resource"
              required
            />
          </div>
          <div class="form-group">
            <label for="new-resource-name">Resource Name</label>
            <input
              type="text"
              id="new-resource-name"
              placeholder="Resource Name"
              required
            />
          </div>
          <div class="form-group">
            <label for="new-resource-category">Category</label>
            <select id="new-resource-category" required>
              <option value="">Select Category</option>
              <option value="food">Food</option>
              <option value="medicine">Medicine</option>
              <option value="essentials">Essentials</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="new-resource-price">Price (₹)</label>
              <input
                type="number"
                id="new-resource-price"
                placeholder="Price"
                min="0"
                step="1"
                required
              />
            </div>
            <div class="form-group">
              <label for="new-resource-stock">Initial Stock</label>
              <input
                type="number"
                id="new-resource-stock"
                placeholder="Stock Quantity"
                min="0"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="new-resource-description">Description</label>
            <textarea
              id="new-resource-description"
              placeholder="Resource Description"
              rows="3"
              required
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('add-resource-modal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Add Resource</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Request Detail Modal -->
    <div class="modal" id="request-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Request Details</h3>
          <span class="close" onclick="closeModal('request-modal')">×</span>
        </div>
        <div id="request-details-content">
          <div class="loadingSpinner"></div>
        </div>
      </div>
    </div>

    <!-- Add Request Modal -->
    <div class="modal" id="add-request-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Request</h3>
          <span class="close" onclick="closeModal('add-request-modal')">×</span>
        </div>
        <form id="add-request-form">
          <div class="form-row">
            <div class="form-group">
              <label for="add-name">Full Name</label>
              <input
                type="text"
                id="add-name"
                placeholder="Full Name"
                required
              />
            </div>
            <div class="form-group">
              <label for="add-phone">Phone Number</label>
              <input
                type="text"
                id="add-phone"
                placeholder="10-digit Phone Number"
                required
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="add-email">Email</label>
              <input type="email" id="add-email" placeholder="Email Address" />
            </div>
            <div class="form-group">
              <label for="add-aadhar">Aadhar (Optional)</label>
              <input
                type="text"
                id="add-aadhar"
                placeholder="12-digit Aadhar Number"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="add-address">Address</label>
            <textarea
              id="add-address"
              placeholder="Full Address"
              required
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="add-ward">Ward Number</label>
              <input
                type="text"
                id="add-ward"
                placeholder="Ward Number"
                required
              />
            </div>
            <div class="form-group">
              <label for="add-pincode">PIN Code</label>
              <input
                type="text"
                id="add-pincode"
                placeholder="6-digit PIN Code"
                required
              />
            </div>
            <div class="form-group">
              <label for="add-family-size">Family Size</label>
              <select id="add-family-size" required>
                <option value="">Select Size</option>
                <option value="1-2">1-2 members</option>
                <option value="3-5">3-5 members</option>
                <option value="6-8">6-8 members</option>
                <option value="8+">More than 8 members</option>
              </select>
            </div>
          </div>

          <h4
            style="
              margin-top: 20px;
              border-bottom: 1px solid #e2e8f0;
              padding-bottom: 10px;
            "
          >
            Resources
          </h4>
          <div id="resource-selection">
            <p style="color: #718096; margin-bottom: 15px">
              Resources will be loaded here...
            </p>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="add-payment-method">Payment Method</label>
              <select id="add-payment-method" required>
                <option value="cod">Cash on Delivery</option>
                <option value="upi">UPI</option>
                <option value="cards">Credit/Debit Cards</option>
                <option value="netbanking">Net Banking</option>
              </select>
            </div>
            <div class="form-group">
              <label for="add-payment-status">Payment Status</label>
              <select id="add-payment-status" required>
                <option value="pending">Pending</option>
                <option value="paid">Paid</option>
                <option value="failed">Failed</option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('add-request-modal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Create Request
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none">
      <div class="toast-icon">
        <i class="fa-solid fa-check"></i>
      </div>
      <div class="toast-content">
        <div class="toast-title">Success</div>
        <div class="toast-message" id="toast-message"></div>
      </div>
    </div>

    <script src="/js/sidebar.js"></script>
    <script>
      // Global variables
      const resources = {
        food: [
          {
            id: "rice",
            name: "Rice (5kg)",
            price: 10,
            category: "food",
            description: "Premium quality white rice",
            stock: 50,
          },
          {
            id: "wheat",
            name: "Wheat Flour (5kg)",
            price: 10,
            category: "food",
            description: "Whole wheat atta for chapatis",
            stock: 45,
          },
          {
            id: "dal",
            name: "Yellow Dal (1kg)",
            price: 5,
            category: "food",
            description: "Toor/Arhar dal, high protein",
            stock: 60,
          },
          {
            id: "oil",
            name: "Cooking Oil (1L)",
            price: 10,
            category: "food",
            description: "Refined vegetable oil",
            stock: 40,
          },
          {
            id: "sugar",
            name: "Sugar (1kg)",
            price: 5,
            category: "food",
            description: "Fine grain white sugar",
            stock: 55,
          },
          {
            id: "salt",
            name: "Salt (1kg)",
            price: 5,
            category: "food",
            description: "Iodized table salt",
            stock: 70,
          },
          {
            id: "tea",
            name: "Tea Leaves (250g)",
            price: 5,
            category: "food",
            description: "Premium black tea leaves",
            stock: 45,
          },
          {
            id: "milk",
            name: "Milk Powder (500g)",
            price: 10,
            category: "food",
            description: "Full cream milk powder",
            stock: 35,
          },
        ],
        medicine: [
          {
            id: "paracetamol",
            name: "Paracetamol (10 tabs)",
            price: 5,
            category: "medicine",
            description: "Fever & pain relief tablets",
            stock: 80,
          },
          {
            id: "oRS",
            name: "ORS Packets (10)",
            price: 5,
            category: "medicine",
            description: "Oral rehydration salts",
            stock: 65,
          },
          {
            id: "vitaminC",
            name: "Vitamin C (30 tabs)",
            price: 10,
            category: "medicine",
            description: "Immunity booster supplements",
            stock: 50,
          },
          {
            id: "antiseptic",
            name: "Antiseptic Solution",
            price: 10,
            category: "medicine",
            description: "For cleaning wounds & cuts",
            stock: 55,
          },
          {
            id: "bandage",
            name: "Bandages (Pack)",
            price: 5,
            category: "medicine",
            description: "Sterile adhesive bandages",
            stock: 60,
          },
          {
            id: "coughSyrup",
            name: "Cough Syrup (100ml)",
            price: 10,
            category: "medicine",
            description: "For dry & wet cough relief",
            stock: 40,
          },
        ],
        essentials: [
          {
            id: "sanitizer",
            name: "Hand Sanitizer (100ml)",
            price: 5,
            category: "essentials",
            description: "70% alcohol-based sanitizer",
            stock: 65,
          },
          {
            id: "mask",
            name: "Face Masks (10pc)",
            price: 5,
            category: "essentials",
            description: "3-ply disposable face masks",
            stock: 75,
          },
          {
            id: "soap",
            name: "Soap Bars (4pc)",
            price: 10,
            category: "essentials",
            description: "Antibacterial bathing soap",
            stock: 60,
          },
          {
            id: "detergent",
            name: "Detergent (500g)",
            price: 10,
            category: "essentials",
            description: "Washing powder for clothes",
            stock: 50,
          },
          {
            id: "candles",
            name: "Candles (Pack of 6)",
            price: 5,
            category: "essentials",
            description: "Emergency lighting solution",
            stock: 70,
          },
          {
            id: "toothpaste",
            name: "Toothpaste (100g)",
            price: 5,
            category: "essentials",
            description: "Fluoride toothpaste",
            stock: 55,
          },
          {
            id: "toilet",
            name: "Toilet Paper (4 rolls)",
            price: 10,
            category: "essentials",
            description: "Soft toilet tissue rolls",
            stock: 45,
          },
        ],
      };

      // Combine all resources into a single array
      const allResources = [
        ...resources.food,
        ...resources.medicine,
        ...resources.essentials,
      ];
      let currentRequestId = null;
      // let allResources = [];
      let allRequests = [];
      let selectedResourcesForRequest = [];
      const API_URL = ""; // Base URL - set if needed

      // Check Admin Access with JWT
      async function checkAdminAccess() {
        const token = localStorage.getItem("token");
        const userEmail = localStorage.getItem("email");
        const isAuthorized = localStorage.getItem("isAdminAuthorized");

        if (isAuthorized === "true") {
          console.log("Admin already authorized, skipping check");
          initDashboard();
          return;
        }

        if (!token || !userEmail) {
          console.log(
            "No token or email found in localStorage, redirecting to /login"
          );
          document.getElementById("error-message").innerText =
            "Please log in to access the admin dashboard.";
          setTimeout(() => (window.location.href = "/login"), 2000);
          return;
        }

        try {
          const response = await fetch("/check-email", {
            headers: {
              "x-user-email": userEmail,
              Authorization: `Bearer ${token}`,
            },
          });
          console.log("Check-email response:", response.status);

          if (response.status === 200) {
            localStorage.setItem("isAdminAuthorized", "true");
            document.getElementById("error-message").innerText = "";
            initDashboard();
          } else {
            console.log("Access denied, redirecting to /login");
            document.getElementById("error-message").innerText =
              "Access denied. Redirecting to login...";
            localStorage.removeItem("isAdminAuthorized");
            setTimeout(() => (window.location.href = "/login"), 2000);
          }
        } catch (error) {
          console.error("Error checking access:", error);
          document.getElementById("error-message").innerText =
            "Server error. Please try again later.";
        }
      }

      // Initialize Dashboard
      function initDashboard() {
        fetchResources();
        fetchDonations();
        fetchRequests();
        fetchStats();
        setupEventListeners();
        initializeParticles();
      }

      // Initialize particles.js
      function initializeParticles() {
        particlesJS("particles-js", {
          particles: {
            number: { value: 30, density: { enable: true, value_area: 800 } },
            color: { value: "#4361ee" },
            opacity: { value: 0.1, random: true },
            size: { value: 3, random: true },
            line_linked: {
              enable: true,
              distance: 150,
              color: "#4361ee",
              opacity: 0.1,
              width: 1,
            },
            move: {
              enable: true,
              speed: 1,
              direction: "none",
              random: true,
              out_mode: "out",
            },
          },
          interactivity: {
            detect_on: "canvas",
            events: { onhover: { enable: true, mode: "grab" } },
          },
        });
      }

      // Setup Event Listeners
      function setupEventListeners() {
        // Update Resource Form
        document
          .getElementById("update-resource-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            updateResource();
          });

        // Add Resource Form
        document
          .getElementById("add-resource-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            addResource();
          });

        // Add Request Form
        document
          .getElementById("add-request-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            addRequest();
          });
      }

      // Fetch Stats
      async function fetchStats() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`${API_URL}/api/admin/stats`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const stats = await response.json();

          // Update stats on dashboard
          document.getElementById("stats-total-requests").textContent =
            stats.requests.total || 0;
          document.getElementById("stats-pending-requests").textContent =
            stats.requests.pending || 0;
          document.getElementById("stats-approved-requests").textContent =
            stats.requests.approved || 0;

          // Count resource categories
          const resourceCount =
            stats.resources.food +
            stats.resources.medicine +
            stats.resources.essentials;
          document.getElementById("stats-total-resources").textContent =
            resourceCount || 0;
        } catch (error) {
          console.error("Error fetching stats:", error);
          showToast("Error loading dashboard statistics", "error");
        }
      }

      // Fetch Resources
      async function fetchResources() {
        try {
          const resourcesGrid = document.getElementById("resources-grid");
          resourcesGrid.innerHTML = '<div class="loadingSpinner"></div>';

          const response = await fetch(`${API_URL}/api/resources`);

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const resources = await response.json();
          allResources = resources;

          if (resources.length === 0) {
            resourcesGrid.innerHTML = `
              <div class="no-items">
                <i class="fa-solid fa-box-open"></i>
                <p>No resources available</p>
                <button class="action-btn" onclick="openAddResourceModal()">
                  <i class="fa-solid fa-plus"></i> Add Resource
                </button>
              </div>
            `;
            return;
          }

          resourcesGrid.innerHTML = resources
            .map(
              (resource) => `
            <div class="resource-card">
              <span class="resource-category category-${resource.category}">${
                resource.category
              }</span>
              <i class="fa-solid fa-${
                resource.category === "food"
                  ? "utensils"
                  : resource.category === "medicine"
                  ? "medkit"
                  : "boxes-stacked"
              }"></i>
              <h3>${resource.name}</h3>
              <div class="resource-details">
                <p>Price: ₹${resource.price}</p>
                <p>Available: ${resource.stock} units</p>
                <span class="status ${
                  resource.stock > 20
                    ? "in-stock"
                    : resource.stock > 0
                    ? "low-stock"
                    : "out-of-stock"
                }">
                  ${
                    resource.stock > 20
                      ? "In Stock"
                      : resource.stock > 0
                      ? "Low Stock"
                      : "Out of Stock"
                  }
                </span>
                <button class="action-btn" onclick="openResourceModal('${
                  resource.id
                }')">
                  <i class="fa-solid fa-pen"></i> Update
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Also update resource selection for add request form
          updateResourceSelectionInForm();
        } catch (error) {
          console.error("Error fetching resources:", error);
          document.getElementById("resources-grid").innerHTML = `
            <div class="no-items">
              <i class="fa-solid fa-exclamation-triangle"></i>
              <p>Error loading resources</p>
              <button class="action-btn" onclick="fetchResources()">
                <i class="fa-solid fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      }

      // Update Resource Selection in Add Request Form
      function updateResourceSelectionInForm() {
        const resourceSelection = document.getElementById("resource-selection");

        if (allResources.length === 0) {
          resourceSelection.innerHTML = `
            <p style="color: #718096;">No resources available. Please add resources first.</p>
          `;
          return;
        }

        // Group resources by category for better organization
        const resourcesByCategory = {};
        allResources.forEach((resource) => {
          if (!resourcesByCategory[resource.category]) {
            resourcesByCategory[resource.category] = [];
          }
          resourcesByCategory[resource.category].push(resource);
        });

        // Create resource selection HTML
        let html = "";

        Object.keys(resourcesByCategory).forEach((category) => {
          html += `<h5 style="margin: 15px 0 10px; color: #4a5568; text-transform: capitalize;">${category}</h5>`;
          html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">`;

          resourcesByCategory[category].forEach((resource) => {
            html += `
              <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: 500;">${resource.name}</div>
                    <div style="font-size: 0.8rem; color: #718096;">₹${resource.price} | ${resource.stock} in stock</div>
                  </div>
                  <div>
                    <input type="number" 
                      min="0" 
                      max="${resource.stock}" 
                      value="0" 
                      style="width: 60px; text-align: center;" 
                      onchange="updateSelectedResources('${resource.id}', this.value)" 
                    />
                  </div>
                </div>
              </div>
            `;
          });

          html += `</div>`;
        });

        resourceSelection.innerHTML = html;
      }

      // Update Selected Resources for Request
      function updateSelectedResources(resourceId, quantity) {
        quantity = parseInt(quantity);

        // Find resource in allResources
        const resource = allResources.find((r) => r.id === resourceId);

        if (!resource) return;

        // Check if resource is already in selectedResourcesForRequest
        const existingIndex = selectedResourcesForRequest.findIndex(
          (r) => r.id === resourceId
        );

        if (quantity > 0) {
          // Add or update resource in selectedResourcesForRequest
          if (existingIndex >= 0) {
            selectedResourcesForRequest[existingIndex].quantity = quantity;
          } else {
            selectedResourcesForRequest.push({
              id: resource.id,
              name: resource.name,
              price: resource.price,
              quantity: quantity,
              category: resource.category,
            });
          }
        } else if (existingIndex >= 0) {
          // Remove resource from selectedResourcesForRequest
          selectedResourcesForRequest.splice(existingIndex, 1);
        }

        console.log("Selected resources:", selectedResourcesForRequest);
      }

      // Fetch Donations
      async function fetchDonations() {
        try {
          const donationsList = document.getElementById("donations-list");
          donationsList.innerHTML = '<div class="loadingSpinner"></div>';

          // This is a placeholder as the original code mentioned donations but didn't have a clear implementation
          // In a real app, you would fetch from an API endpoint
          setTimeout(() => {
            donationsList.innerHTML = `
              <div class="no-items">
                <i class="fa-solid fa-hand-holding-heart"></i>
                <p>No pending donations available</p>
              </div>
            `;
          }, 500);
        } catch (error) {
          console.error("Error fetching donations:", error);
          document.getElementById("donations-list").innerHTML = `
            <div class="no-items">
              <i class="fa-solid fa-exclamation-triangle"></i>
              <p>Error loading donations</p>
              <button class="action-btn" onclick="fetchDonations()">
                <i class="fa-solid fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      }

      // Refresh Donations
      function refreshDonations() {
        fetchDonations();
        showToast("Donations refreshed successfully", "success");
      }

      // Fetch Requests
      async function fetchRequests() {
        try {
          const requestsTable = document.getElementById("requests-table");
          document.getElementById("requests-loading").style.display = "block";
          document.getElementById("no-requests").style.display = "none";

          const token = localStorage.getItem("token");
          const response = await fetch(`${API_URL}/api/admin/requests`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const requests = await response.json();
          allRequests = requests;

          document.getElementById("requests-loading").style.display = "none";

          if (requests.length === 0) {
            document.getElementById("no-requests").style.display = "block";
            return;
          }

          // Create table header
          let tableHTML = `
            <div class="table-header">
              <div>Request ID</div>
              <div>Name</div>
              <div>Email</div>
              <div>Type</div>
              <div>Amount</div>
              <div>Status</div>
              <div>Actions</div>
            </div>
          `;

          // Add table rows
          tableHTML += requests
            .map(
              (req) => `
            <div class="table-row" data-email="${
              req.email
            }" data-status="${req.status.toLowerCase()}" data-name="${
                req.name
              }">
              <div>${req.request_id}</div>
              <div>${req.name}</div>
              <div>${req.email || "N/A"}</div>
              <div>${req.requestType || "Mixed"}</div>
              <div>₹${req.totalAmount || 0}</div>
              <div>
                <span class="badge badge-${req.status.toLowerCase()}">${
                req.status
              }</span>
              </div>
              <div style="white-space: nowrap;">
                <button class="action-btn view-btn" onclick="viewRequestDetails(${
                  req.request_id
                })">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="action-btn accept-btn" onclick="handleRequestAction(${
                  req.request_id
                }, 'approved')" ${
                req.status.toLowerCase() !== "pending" ? "disabled" : ""
              }>
                  <i class="fa-solid fa-check"></i>
                </button>
                <button class="action-btn reject-btn" onclick="handleRequestAction(${
                  req.request_id
                }, 'rejected')" ${
                req.status.toLowerCase() !== "pending" ? "disabled" : ""
              }>
                  <i class="fa-solid fa-times"></i>
                </button>
              </div>
            </div>
          `
            )
            .join("");

          requestsTable.innerHTML = tableHTML;
        } catch (error) {
          console.error("Error fetching requests:", error);
          document.getElementById("requests-loading").style.display = "none";
          document.getElementById("no-requests").style.display = "block";
          document.getElementById("no-requests").innerHTML = `
            <i class="fa-solid fa-exclamation-triangle"></i>
            <p>Error loading requests</p>
            <button class="action-btn" onclick="fetchRequests()">
              <i class="fa-solid fa-refresh"></i> Try Again
            </button>
          `;
        }
      }

      // Filter Requests
      function filterRequests() {
        const search = document.getElementById("search").value.toLowerCase();
        const statusFilter = document.getElementById("status-filter").value;
        const rows = document.querySelectorAll(".table-row");
        let visibleCount = 0;

        rows.forEach((row) => {
          const email = row.dataset.email.toLowerCase();
          const name = row.dataset.name.toLowerCase();
          const status = row.dataset.status.toLowerCase();

          const matchesSearch = email.includes(search) || name.includes(search);
          const matchesStatus =
            statusFilter === "all" || status === statusFilter;

          if (matchesSearch && matchesStatus) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        if (visibleCount === 0) {
          document.getElementById("no-requests").style.display = "block";
          document.getElementById("no-requests").innerHTML = `
            <i class="fa-solid fa-filter"></i>
            <p>No matching requests found</p>
          `;
        } else {
          document.getElementById("no-requests").style.display = "none";
        }
      }

      // View Request Details
      async function viewRequestDetails(requestId) {
        try {
          currentRequestId = requestId;
          openModal("request-modal");

          const detailsContainer = document.getElementById(
            "request-details-content"
          );
          detailsContainer.innerHTML = '<div class="loadingSpinner"></div>';

          // Try to find the request in already loaded requests
          let request = allRequests.find((r) => r.request_id === requestId);

          // If not found, fetch it directly (optional fallback)
          if (!request) {
            const token = localStorage.getItem("token");
            const response = await fetch(
              `${API_URL}/api/requests/${requestId}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            if (response.ok) {
              request = await response.json();
            }
          }

          if (!request) {
            detailsContainer.innerHTML = `
              <div class="error-message">
                Request details not found
              </div>
            `;
            return;
          }

          // Format request details
          const formattedDate = new Date(request.createdAt).toLocaleDateString(
            "en-US",
            {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            }
          );

          let html = `
            <h4 style="margin: 0 0 20px; color: #2d3748;">Request #${
              request.request_id
            }</h4>
            
            <div class="request-details-grid">
              <p>
                <strong>Name</strong>
                <span>${request.name}</span>
              </p>
              <p>
                <strong>Contact</strong>
                <span>${request.phone}</span>
              </p>
              <p>
                <strong>Email</strong>
                <span>${request.email || "Not provided"}</span>
              </p>
              <p>
                <strong>Date Requested</strong>
                <span>${formattedDate}</span>
              </p>
              <p>
                <strong>Address</strong>
                <span>${request.address}, Ward ${request.wardno}, ${
            request.pincode
          }</span>
              </p>
              <p>
                <strong>Family Size</strong>
                <span>${request.familySize || "Not specified"}</span>
              </p>
              <p>
                <strong>Payment Method</strong>
                <span>${
                  request.paymentMethod === "upi"
                    ? "UPI"
                    : request.paymentMethod === "cards"
                    ? "Credit/Debit Card"
                    : request.paymentMethod === "netbanking"
                    ? "Net Banking"
                    : "Cash on Delivery"
                }</span>
              </p>
              <p>
                <strong>Payment Status</strong>
                <span>${
                  request.paymentStatus === "pending"
                    ? "Pending"
                    : request.paymentStatus === "paid"
                    ? "Paid"
                    : "Failed"
                }</span>
              </p>
            </div>
          `;

          if (request.items && request.items.length > 0) {
            html += `<h4 style="margin: 20px 0 10px; color: #2d3748;">Requested Items</h4>`;
            html += `<div class="request-items">`;

            request.items.forEach((item) => {
              html += `
                <div class="request-item">
                  <div class="request-item-details">
                    <div class="request-item-name">${item.name}</div>
                    <div class="request-item-meta">
                      ${item.quantity} × ₹${item.price} (${item.category})
                    </div>
                  </div>
                  <div class="request-item-price">₹${
                    item.price * item.quantity
                  }</div>
                </div>
              `;
            });

            html += `
              <div class="request-item" style="background: #f1f5f9; font-weight: bold;">
                <div class="request-item-details">Total</div>
                <div class="request-item-price">₹${request.totalAmount}</div>
              </div>
            </div>`;
          }

          html += `<h4 style="margin: 20px 0 10px; color: #2d3748;">Actions</h4>`;

          if (request.status.toLowerCase() === "pending") {
            html += `
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="action-btn accept-btn" style="flex: 1;" onclick="handleRequestAction(${request.request_id}, 'approved')">
                  <i class="fa-solid fa-check"></i> Approve Request
                </button>
                <button class="action-btn reject-btn" style="flex: 1;" onclick="handleRequestAction(${request.request_id}, 'rejected')">
                  <i class="fa-solid fa-times"></i> Reject Request
                </button>
              </div>
            `;
          } else if (request.status.toLowerCase() === "approved") {
            html += `
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="action-btn" style="flex: 1; background: #10b981;" onclick="handleRequestAction(${request.request_id}, 'delivered')">
                  <i class="fa-solid fa-truck"></i> Mark as Delivered
                </button>
                <button class="action-btn reject-btn" style="flex: 1;" onclick="handleRequestAction(${request.request_id}, 'rejected')">
                  <i class="fa-solid fa-times"></i> Reject Request
                </button>
              </div>
            `;
          } else {
            html += `
              <div style="padding: 15px; background: #f8fafc; border-radius: 8px; text-align: center; color: #718096;">
                No actions available for ${request.status} requests
              </div>
            `;
          }

          detailsContainer.innerHTML = html;
        } catch (error) {
          console.error("Error viewing request details:", error);
          document.getElementById("request-details-content").innerHTML = `
            <div class="error-message">
              Error loading request details. Please try again.
            </div>
          `;
        }
      }

      // Handle Request Action (Approve/Reject/Deliver)
      async function handleRequestAction(requestId, status) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            `${API_URL}/api/admin/requests/${requestId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ status }),
            }
          );

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          // Close modal if open
          closeModal("request-modal");

          // Update the UI
          fetchRequests();
          fetchStats();

          // Show toast notification
          const action =
            status === "approved"
              ? "approved"
              : status === "rejected"
              ? "rejected"
              : "marked as delivered";
          showToast(`Request ${requestId} has been ${action}`, "success");
        } catch (error) {
          console.error(`Error updating request status:`, error);
          showToast(`Failed to update request status`, "error");
        }
      }

      // Open Resource Modal
      function openResourceModal(resourceId) {
        const resource = allResources.find((r) => r.id === resourceId);

        if (!resource) {
          showToast("Resource not found", "error");
          return;
        }

        document.getElementById("resource-id").value = resource.id;
        document.getElementById("resource-name").value = resource.name;
        document.getElementById("resource-category").value = resource.category;
        document.getElementById("resource-price").value = resource.price;
        document.getElementById("resource-stock").value = resource.stock;
        document.getElementById("resource-description").value =
          resource.description;

        openModal("resource-modal");
      }

      // Update Resource
      async function updateResource() {
        try {
          const resourceId = document.getElementById("resource-id").value;
          const price = parseFloat(
            document.getElementById("resource-price").value
          );
          const stock = parseInt(
            document.getElementById("resource-stock").value
          );
          const description = document.getElementById(
            "resource-description"
          ).value;

          if (isNaN(price) || price < 0) {
            showToast("Please enter a valid price", "error");
            return;
          }

          if (isNaN(stock) || stock < 0) {
            showToast("Please enter a valid stock quantity", "error");
            return;
          }

          const token = localStorage.getItem("token");
          const response = await fetch(
            `${API_URL}/api/resources/${resourceId}/stock`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ stock }),
            }
          );

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          // Close modal
          closeModal("resource-modal");

          // Refresh resources
          fetchResources();

          // Show toast notification
          showToast("Resource updated successfully", "success");
        } catch (error) {
          console.error("Error updating resource:", error);
          showToast("Failed to update resource", "error");
        }
      }

      // Open Add Resource Modal
      function openAddResourceModal() {
        document.getElementById("add-resource-form").reset();
        openModal("add-resource-modal");
      }

      // Add Resource
      async function addResource() {
        try {
          const id = document.getElementById("new-resource-id").value;
          const name = document.getElementById("new-resource-name").value;
          const category = document.getElementById(
            "new-resource-category"
          ).value;
          const price = parseFloat(
            document.getElementById("new-resource-price").value
          );
          const stock = parseInt(
            document.getElementById("new-resource-stock").value
          );
          const description = document.getElementById(
            "new-resource-description"
          ).value;

          if (
            !id ||
            !name ||
            !category ||
            isNaN(price) ||
            isNaN(stock) ||
            !description
          ) {
            showToast("Please fill all required fields", "error");
            return;
          }

          // Create resource object
          const resource = {
            id,
            name,
            category,
            price,
            stock,
            description,
          };

          // In a real implementation, you would send this to an API endpoint
          console.log("Adding resource:", resource);

          // Simulate API call (replace with actual API call)
          allResources.push(resource);

          // Close modal
          closeModal("add-resource-modal");

          // Refresh resources
          fetchResources();

          // Show toast notification
          showToast("Resource added successfully", "success");
        } catch (error) {
          console.error("Error adding resource:", error);
          showToast("Failed to add resource", "error");
        }
      }

      // Open Add Request Modal
      function openAddRequestModal() {
        document.getElementById("add-request-form").reset();
        selectedResourcesForRequest = [];
        updateResourceSelectionInForm();
        openModal("add-request-modal");
      }

      // Add Request
      async function addRequest() {
        try {
          // Get form values
          const name = document.getElementById("add-name").value;
          const phone = document.getElementById("add-phone").value;
          const email = document.getElementById("add-email").value;
          const aadhar = document.getElementById("add-aadhar").value;
          const address = document.getElementById("add-address").value;
          const wardno = document.getElementById("add-ward").value;
          const pincode = document.getElementById("add-pincode").value;
          const familySize = document.getElementById("add-family-size").value;
          const paymentMethod =
            document.getElementById("add-payment-method").value;
          const paymentStatus =
            document.getElementById("add-payment-status").value;

          // Validation
          if (
            !name ||
            !phone ||
            !address ||
            !wardno ||
            !pincode ||
            !familySize
          ) {
            showToast("Please fill all required fields", "error");
            return;
          }

          if (selectedResourcesForRequest.length === 0) {
            showToast("Please select at least one resource", "error");
            return;
          }

          // Calculate total amount
          const totalAmount = selectedResourcesForRequest.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );

          // Create request object
          const requestData = {
            name,
            phone,
            email,
            aadhar,
            address,
            wardno,
            pincode,
            familySize,
            items: selectedResourcesForRequest,
            totalAmount,
            paymentMethod,
            paymentStatus,
          };

          console.log("Adding request:", requestData);

          // Make API call
          const response = await fetch(`${API_URL}/api/requests`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          // Close modal
          closeModal("add-request-modal");

          // Reset form and selected resources
          document.getElementById("add-request-form").reset();
          selectedResourcesForRequest = [];

          // Refresh requests
          fetchRequests();
          fetchStats();

          // Show toast notification
          showToast("Request added successfully", "success");
        } catch (error) {
          console.error("Error adding request:", error);
          showToast("Failed to add request", "error");
        }
      }

      // Modal Functions
      function openModal(id) {
        document.getElementById(id).style.display = "block";
        // Prevent body scrolling when modal is open
        document.body.style.overflow = "hidden";
      }

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
        // Re-enable body scrolling
        document.body.style.overflow = "";
      }

      // Show Toast Notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");
        const toastTitle = document.querySelector(".toast-title");
        const toastIcon = document.querySelector(".toast-icon i");

        // Set toast type
        toast.className = "toast " + type;

        // Set title and icon based on type
        if (type === "success") {
          toastTitle.textContent = "Success";
          toastIcon.className = "fa-solid fa-check";
        } else {
          toastTitle.textContent = "Error";
          toastIcon.className = "fa-solid fa-exclamation";
        }

        // Set message
        toastMessage.textContent = message;

        // Show toast
        toast.style.display = "flex";

        // Auto-hide toast after 3 seconds
        setTimeout(() => {
          toast.style.display = "none";
        }, 3000);
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modals = document.getElementsByClassName("modal");
        for (let modal of modals) {
          if (event.target == modal) {
            modal.style.display = "none";
            document.body.style.overflow = "";
          }
        }
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", checkAdminAccess);
    </script>
  </body>
</html>
